# 「Cuiping 式」语法

「Cuiping 式」精确描述一个「化学结构」

## 原子团

「化学结构」由一个「原子团」开始。「原子团」可以：
- 包含大小写字母，大写字母后的小写字母会与之合并在一个字框内（使元素符号更自然）
- 包含数字，数字会被渲染为下标形式
- 是一个单独的「通配符 `*`」，不渲染（用于表示取代基）
- 是一个单独的「塌缩碳原子 `.`」，不渲染，与之相连的键不会留白（类似键线式）

「原子团」可以包含「原子团内排版」：
- 用 `^`/`_` 表示上标/下标其后的一个字符
- 当 `^`/`_` 后是 `()` 包裹的字符时，上标/下标其中所有的字符
- 上标和下标的字符没有限制

## 属性

「原子团」后可以出现「属性组」：
- 「属性组」书写在 `{}` 内
- 「属性组」中有至少一条「属性」，多条「属性」用 `,` 隔开

「属性」分为字符串类型和布尔（开关）类型
- 字符串类型的「属性」，需包含「属性名」和「属性值」，用 `:` 隔开
- 布尔类型的「属性」，仅包含「属性名」
- [支持的「属性」列表](#属性列表)

## 键

「原子团」后可以跟随「键」，如有「属性组」则在其后：
- 跟随多个「键」，称为「键组」，书写在 `[]` 内，用 `,` 隔开
- 跟随单个「键」
- 单个「键」和「键组」可以同时存在，这时单个「键」要写在「键组」的后面

「键」的写法：
- 「键」由「键类型」和其连接的「化学结构」组成
- 「键类型」描述键的根数和方向，「键根数」在前，「键方向」在后
- 「键类型」的开始可以有「键修饰符」

「键根数」：
- 用 `=` 表示双键，`#` 表示三键 
- 默认为单键

「键方向」和书写结构式的习惯相同：
- 用 `-`、`|`、`/`、`\` 分别表示 0°、90°、60°、270° 的「键」
- 「键方向」可以为 `+`，见[重迭书写规则](#键的重迭书写)
- 当「键类型」写在连接的「化学结构」前时，方向即如上条所说；写在其后时，则反向（加上 180°）
- 「键类型」写在连接的「化学结构」后时，只能出现在「键组」内
- 「键方向」不得重复（出键）；也不得于连接其所属的「原子团」的「键」的方向相同（入键）

「键修饰符」：
- 「键修饰符 `!`」使其后的「键方向」都增加 180°（这样可以在「键组」外书写反方向的键）

「键方向」的简写规则：
- 当有「键根数」时，可以不出现「键方向」，默认为 0°
- 当有「键修饰符 `!`」 时，可以不出现「键根数」和「键方向」，即为 180°

## 键的重迭书写

可以通过重迭书写多个「键方向」来表示连接相同的「化学结构」：
- 「键方向」为 `+` 时，代表上下左右四个「键方向」
- 重迭书写时，允许相同「键方向」出现两次，第二次会被自动转为反向
- 当出现与第一个「键方向」以 x/y 轴对称的「键方向」时，后者连接的「化学结构」中的所有「键」会被按 x/y 轴翻转（但其中「原子团」的文字目前不会有任何改变）
- 其他「键方向」连接的「化学结构」中的所有键，会被旋转一个与该「键方向」和第一个「键方向」夹角相同的角度

## 属性列表

原子团属性：

| 属性名    | 别名 | 类型   | 用途
| :-------- | :--- | :----- | :---
| `color`   | `C`  | 字符串 | 指定文字颜色
| `bold`    | `B`  | 布尔   | 使文字加粗

键属性：

| 属性名       | 别名      | 类型        | 用途
| :----------- | :-------- | :---------- | :---
| `color`      | `C`       | 字符串      | 指定键颜色
| `highEnergy` | `HE`, `~` | 布尔        | 绘制高能键（波浪线）
| `from`       | `<`       | 布尔 / 整数 | 配位键，方向沿键方向来。整数指定箭头数。
| `to`         | `>`       | 布尔 / 整数 | 配位键，方向沿键方向去。整数指定箭头数。

## 范式

```
cuiping         = <chem>
chem            = <group> (<bonds>)? (<bond>)?
bonds           = [ <bond> (, <bond>)* ]
bond            = <pre bond> | <post bond>
pre bond        = <bond dir> <cuiping>
post bond       = <cuiping> <bond dir>
bond dir        = (<bond count> <bond dir> | <bond count> | <bond dir>)
                | <bond modifier> ((bond count)? (bond dir)?)
bond count      = '=' | #
bond dir        = (+ | - | / | \ | '|')+
bond modifier   = !
group           = group ((<identifier>)+ | <group typeset>)
group typeset   = (^ | _)(<char> | '(' (<char>)+ ')')
identifier      = (<letter> | <number> | '(' | ')')+ | . | '*'
```