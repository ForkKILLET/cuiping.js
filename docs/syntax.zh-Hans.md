# 「Cuiping 式」语法

[English](./syntax.md) | 简体中文

「Cuiping 式」精确描述一个「化学结构」

## 原子团

「化学结构」由一个「原子团」开始。「原子团」可以：
- 包含大小写字母，大写字母后的小写字母会与之合并在一个字框内（使元素符号更自然）
- 包含数字，数字会被渲染为下标形式
- 是一个单独的「通配符 `?`」，不渲染（用于表示取代基）
- 是一个单独的「塌缩碳原子 `.`」，不渲染，与之相连的键不会留白（类似键线式）

「原子团」可以包含「原子团内排版」：
- 用 `^`/`_`/`` ` `` 表示上标/下标/正常显示其后的一个字符
- 当 `^`/`_`/`` ` `` 后是 `()` 包裹的字符时，上标/下标/正常显示其中所有的字符
- 「原子团内排版」中的字符，没有限制

## 属性

「原子团」后可以出现「属性组」：
- 「属性组」书写在 `{}` 内
- 「属性组」中有至少一条「属性」，多条「属性」用 `,` 隔开（允许悬挂的 `,`）

「属性」分为字符串类型、整数类型、浮点类型和布尔（开关）类型
- 字符串、整数或浮点类型的「属性」，需包含「属性名」和「属性值」，用 `:` 隔开
- 整数/浮点数类型的「属性」的「属性值」，需要是一个整数/浮点数
- 布尔类型的「属性」，仅包含「属性名」
- [支持的「属性」列表](#属性列表)

## 键

「原子团」后可以跟随「键」，如有「属性组」则在其后：
- 跟随多个「键」，称为「键组」，书写在 `[]` 内，用 `,` 隔开（允许悬挂的 `,`）
- 跟随单个「键」
- 单个「键」和「键组」可以同时存在，这时单个「键」要写在「键组」的后面

「键」的写法：
- 「键」由「键类型」和其连接的「化学结构」组成
- 「键类型」描述键的根数和方向，「键根数」在前，「键方向」在后
- 「键类型」的开始可以有「键修饰符」

「键根数」：
- 用 `=` 表示双键，`#` 表示三键 
- 默认为单键

「键方向」和书写结构式的习惯相同：
- 用 `-`、`|`、`/`、`\` 分别表示 0°、90°、60°、270° 的「键」
- 「键方向」可以为 `+`，见[重迭书写规则](#键的重迭书写)
- 当「键类型」写在连接的「化学结构」前时，方向即如上条所说；写在其后时，则反向（加上 180°）
- 「键类型」写在连接的「化学结构」后时，只能出现在「键组」内
- 「键方向」不得重复（出键）；也不得与连接其所属的「原子团」的「键」的方向相同（入键）

「键修饰符」：
- 「键修饰符 `*`」将「键」的长度（`length` 「属性」)）设置为 0
- 「键修饰符 `!`」使其后的「键方向」都增加 180°（这样可以在「键组」外书写反方向的键）
- 「键修饰符 `~`」使其后的「键方向」中，为 `/` 或 `\` 的，与 x 轴夹角从 60° 变为 30°

「键方向」的简写规则：
- 当有「键根数」时，可以不出现「键方向」，默认为 0°
- 当有「键修饰符 `!`」 时，可以不出现「键根数」和「键方向」，即为 180°

## 键的重迭书写

可以通过重迭书写多个「键方向」来表示连接相同的「化学结构」：
- 「键方向」为 `+` 时，代表上下左右四个「键方向」
- 重迭书写时，允许相同「键方向」出现两次，第二次会被自动转为反向
- 当出现与第一个「键方向」以 x/y 轴对称的「键方向」时，后者连接的「化学结构」中的所有「键」会被按 x/y 轴翻转（但其中「原子团」的文字目前不会有任何改变）
- 其他「键方向」连接的「化学结构」中的所有「键」，会被旋转一个与该「键方向」和第一个「键方向」夹角相同的角度

## 引用

「引用」可以用于将复杂的「化学结构」拆分开来表示

- 用 `ref` 「属性」给某个「化学结构」命名，从而可被引用
- 把引用名称写在 `&` 符号后面，就构成一个「引用」，其可以像「原子团」一样跟随「键」
- 用 `;` 隔开不同的「化学结构」。（允许悬挂的 `;`）最终，通过「引用」的连接，这些「化学结构」必须完全连通
- 「引用」不能通过「键」连接到它本身（即不允许出现自环）

## 属性列表

原子团属性：

| 属性名    | 别名 | 类型   | 用途
| :-------- | :--- | :----- | :---
| `color`   | `C`  | 字符串 | 指定文字颜色
| `bold`    | `B`  | 布尔   | 使文字加粗
| `ref`     | `&`  | 字符串 | 命名引用

键属性：

| 属性名       | 别名      | 类型        | 用途
| :----------- | :-------- | :---------- | :---
| `color`      | `C`       | 字符串      | 指定键颜色
| `highEnergy` | `HE`, `~` | 布尔        | 绘制高能键（波浪线）
| `from`       | `<`       | 布尔 / 整数 | 配位键，方向沿键方向来；整数指定箭头数
| `to`         | `>`       | 布尔 / 整数 | 配位键，方向沿键方向去；整数指定箭头数
| `length`     | `L`       | 浮点数      | 指定键长度（是单位长度的倍数，默认为 1）

## 范式

```
cuiping         = <struct> (; <struct>)*
struct          = <chem struct> | <ref struct>
bond list       = (<bonds>)? | (<bond>)?
chem struct     = <group> <bond list>
ref struct      = & <identifier> <bond list>
bonds           = [ <bond> (, <bond>)* ]
bond            = <pre bond> | <post bond>
pre bond        = <bond type> <struct>
post bond       = <struct> <bond type>
bond type       = (<bond count> <bond dir> | <bond count> | <bond dir>)
                | (<bond modifier> (<bond count>)? (<bond dir>)?)
bond count      = '=' | '#'
bond dir        = ('+' | '-' | '/' | '\' | '|')+
bond modifier   = '!' | '*'
group           = <group> ((<group char>)+ | <group typeset>)
group typeset   = ('^' | '_')(<any char> | '{' (<any char>)+ '}')
identifier      = <any letter> | <any number>
group char      = <identifier> | '(' | ')' | '.' | '?'
```
